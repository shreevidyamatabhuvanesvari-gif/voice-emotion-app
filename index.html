<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Anjali ‚Äì Strict Voice Activation</title>
</head>
<body>

<h2>Anjali</h2>

<button onclick="startListening()">üé§ ‡§∏‡•Å‡§®‡§ø‡§è (‡§Ö‡§Ç‡§ú‡§≤‡•Ä ‡§¨‡•ã‡§≤‡•á‡§Ç)</button>

<p><b>‡§∏‡•Å‡§®‡§æ ‡§ó‡§Ø‡§æ:</b> <span id="heard"></span></p>
<p><b>‡§â‡§§‡•ç‡§§‡§∞:</b> <span id="response"></span></p>

<script>
/* ---------- Speech Recognition ---------- */
const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

const recognition = new SpeechRecognition();
recognition.lang = "hi-IN";
recognition.continuous = false;
recognition.interimResults = false;

let lastReply = "";

function startListening() {
    recognition.start();
}

/* ---------- ‡§∏‡•Å‡§®‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ---------- */
recognition.onresult = function(event) {
    const spokenText = event.results[0][0].transcript;
    document.getElementById("heard").innerText = spokenText;

    /* ‡§ï‡§†‡•ã‡§∞ ‡§®‡§ø‡§Ø‡§Æ: ‚Äú‡§Ö‡§Ç‡§ú‡§≤‡•Ä‚Äù ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø */
    if (!spokenText.includes("‡§Ö‡§Ç‡§ú‡§≤‡•Ä")) {
        document.getElementById("response").innerText =
            "‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è '‡§Ö‡§Ç‡§ú‡§≤‡•Ä' ‡§ï‡§π‡•á‡§Ç‡•§";
        return;
    }

    sendToBackend(spokenText);
};

/* ---------- Backend ---------- */
function sendToBackend(text) {
    fetch("http://127.0.0.1:5000/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    })
    .then(res => res.json())
    .then(data => {
        lastReply = data.reply;
        document.getElementById("response").innerText = lastReply;
        speak(lastReply);
    });
}

/* ---------- ‡§¨‡•ã‡§≤‡§®‡§æ (Guaranteed) ---------- */
function speak(text) {
    if (!text) return;

    const utterance = new SpeechSynthesisUtterance(text);

    const voices = speechSynthesis.getVoices();
    const hindi = voices.find(v => v.lang.startsWith("hi"));
    if (hindi) utterance.voice = hindi;

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}
</script>

</body>
</html>
