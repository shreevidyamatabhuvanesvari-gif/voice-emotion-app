<script>
let voicesLoaded = false;
let cachedVoices = [];

/* ---------- Voice Engine को force-load ---------- */
window.speechSynthesis.onvoiceschanged = function () {
    cachedVoices = window.speechSynthesis.getVoices();
    voicesLoaded = true;
};

/* ---------- Guaranteed Speak ---------- */
function speak(text) {

    let toSpeak = "";

    if (typeof text === "string") {
        toSpeak = text.trim();
    } else if (text !== null && text !== undefined) {
        toSpeak = String(text);
    }

    if (toSpeak === "") {
        toSpeak = "मैं सुन रही हूँ।";
    }

    function actuallySpeak() {
        const utterance = new SpeechSynthesisUtterance(toSpeak);

        const hindiVoice = cachedVoices.find(v => v.lang.startsWith("hi"));
        if (hindiVoice) {
            utterance.voice = hindiVoice;
        }

        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }

    /* अगर voices अभी तक load नहीं हुई */
    if (!voicesLoaded) {
        setTimeout(() => {
            cachedVoices = window.speechSynthesis.getVoices();
            voicesLoaded = true;
            actuallySpeak();
        }, 300);
    } else {
        actuallySpeak();
    }
}
</script>
